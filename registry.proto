syntax = "proto3";

option go_package = "github.com/fuddle-io/fuddle-rpc;rpc";

package registry;

service Registry {
	// Register registers a node into the registry.
	rpc Register(RegisterRequest) returns (RegisterResponse) {}

	// DEPRICATED
	rpc RegisterV2(RegisterRequest) returns (RegisterResponse) {}

	// Unregister unregisters a node from the registry.
	rpc Unregister(UnregisterRequest) returns (UnregisterResponse) {}

	// UpdateNode updates the state of a node in the registry.
	rpc UpdateNode(UpdateNodeRequest) returns (UpdateNodeResponse) {}

	// Updates streams updates to the registry.
	rpc Updates(UpdatesRequest) returns (stream NodeUpdate) {}

	// Nodes returns the set of nodes in the cluster.
	rpc Nodes(NodesRequest) returns (NodesResponse) {}

	// Node returns the node with the requested ID.
	rpc Node(NodeRequest) returns (NodeResponse) {}
}

// DEPRICATED
enum MessageType {
	// Message describes an update to a nodes entry in the registry.
	NODE_UPDATE = 0;

	// Messages contains a heartbeat, used to check for liveness.
	HEARTBEAT = 1;

	// Messages contains an error.
	ERROR = 2;
}

// DEPRICATED
message Message {
	MessageType message_type = 1;
	optional NodeUpdate node_update = 2;
	optional Heartbeat heartbeat = 3;
	optional Error error = 4;
}

enum NodeUpdateType {
	REGISTER = 0;
	UNREGISTER = 1;
	METADATA = 2;
}

// Contains the set of immutable attributes for the node.
message NodeAttributes {
	// Service is the type of service running on the node.
	string service = 1;

	// Locality is the location of the node in the cluster.
	string locality = 2;

	// Created is the time the node was created in UNIX milliseconds.
	int64 created = 3;

	// Revision identifies the version of the service running on the node.
	string revision = 4;
}

message VersionedValue {
	string value = 1;
	uint64 version = 2;
}

message Node {
	// ID of the node.
	string id = 1;

	// Version of the node. Note this is only set by the Fuddle server, not the
	// client.
	uint64 version = 2;

	// Set of immutable attributes for the node.
	NodeAttributes attributes = 3;

	// Application defined node metadata. The metadata entries versions will
	// only be set by the Fuddle server, not the client.
	map<string, VersionedValue> metadata = 4;
}

// Describes an update to a nodes entry in the registry.
message NodeUpdate {
	// ID of the node being updated.
	string node_id = 1;

	// Type of update to the node.
	NodeUpdateType update_type = 2;

	// Version of the node after the update. Note this is only set by the
	// Fuddle server, not the client.
	uint64 version = 3;

	// Set of immutable attributes for the node. The attributes are only set
	// for REGISTER updates since they are immutable.
	NodeAttributes attributes = 4;

	// Application defined node metadata. The metadata entries versions will
	// only be set by the Fuddle server, not the client.
	map<string, VersionedValue> metadata = 5;
}

message Heartbeat {
	// Timestamp is set by the client and echoed back by the server.
	int64 timestamp = 1;
}

enum ErrorStatus {
	// Attempting to update a node that is not registered.
	NOT_REGISTERED = 0;
	// Attempting to register a node that is already in the registry.
	ALREADY_REGISTERED = 1;
	// Protocol error occured.
	PROTOCOL = 2;
	// Resuorce not found.
	NOT_FOUND = 3;
	// Unknown error.
	UNKNOWN = 4;
}

message Error {
	// Error status contains an enum describing the error.
	ErrorStatus status = 1;
	string description = 2;
}

message RegisterRequest {
	Node node = 1;
}

message RegisterResponse {
	Error error = 1;
}

message UnregisterRequest {
	string node_id = 1;
}

message UnregisterResponse {
	Error error = 1;
}

message UpdateNodeRequest {
	string node_id = 1;
	map<string, string> metadata = 2;
}

message UpdateNodeResponse {
	Error error = 1;
}

message UpdatesRequest {
}

message NodesRequest {
	bool include_metadata = 1;
}

message NodesResponse {
	repeated Node nodes = 1;
	Error error = 2;
}

message NodeRequest {
	string node_id = 1;
}

message NodeResponse {
	Node node = 1;
	Error error = 2;
}
